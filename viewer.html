<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Face 3D Model - AR/VR Viewer</title>
    <style>
      body {margin:0;overflow:hidden;background:#111;font-family:Arial;}
      #info {position:absolute;top:10px;left:10px;color:#fff;z-index:100;background:rgba(0,0,0,0.7);padding:10px;border-radius:5px;}
      #loading {position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:18px;}
      #controls {position:absolute;bottom:10px;left:10px;z-index:100;}
      .btn {background:#007acc;color:white;padding:10px 15px;margin:5px;border:none;border-radius:5px;cursor:pointer;font-size:14px;}
      .btn:hover {background:#005a9e;}
      .btn:disabled {background:#555;cursor:not-allowed;}
    </style>
  </head>
  <body>
    <div id="info">
      <strong>ğŸ­ Your 3D Face Model</strong><br>
      Mouse: Orbit | Wheel: Zoom | Click VR/AR buttons below
    </div>
    <div id="loading">Loading your 3D face model...</div>
    
    <div id="controls">
      <button id="vrButton" class="btn" disabled>Loading... ğŸ¥½</button>
      <button id="arButton" class="btn" disabled>Loading... ğŸ“±</button>
      <button id="fullscreenBtn" class="btn">Fullscreen ğŸ“º</button>
      <button id="lifeSize" class="btn">Life Size ğŸ‘¤</button>
      <button id="closeUp" class="btn">Close-up ğŸ”</button>
      <button id="mirror" class="btn">Mirror Mode ğŸª</button>
    </div>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
      }
    }
    </script>
    <script type="module">
      import * as THREE from 'three';
      import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
      import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      import { VRButton } from 'three/addons/webxr/VRButton.js';
      import { ARButton } from 'three/addons/webxr/ARButton.js';

      const loadingDiv = document.getElementById('loading');
      const vrButton = document.getElementById('vrButton');
      const arButton = document.getElementById('arButton');
      const fullscreenBtn = document.getElementById('fullscreenBtn');
      const lifeSizeBtn = document.getElementById('lifeSize');
      const closeUpBtn = document.getElementById('closeUp');
      const mirrorBtn = document.getElementById('mirror');
      
      // Scene setup
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0x111111);
      renderer.xr.enabled = true; // Enable WebXR for VR/AR
      document.body.appendChild(renderer.domElement);
      
      // Setup VR/AR support
      setupWebXR();

      // Controls
      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // Lighting
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
      
      // Additional light from the opposite side
      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.3);
      directionalLight2.position.set(-1, -1, -1);
      scene.add(directionalLight2);

      // Load textured OBJ model with materials
      function loadTexturedModel() {
        const mtlLoader = new MTLLoader();
        
        // First load materials
        mtlLoader.load('face.mtl', 
          function (materials) {
            console.log('âœ… Materials loaded successfully');
            materials.preload();
            
            // Then load OBJ with materials
            const objLoader = new OBJLoader();
            objLoader.setMaterials(materials);
            
            objLoader.load('face.obj',
              function (obj) {
                console.log('âœ… Textured face model loaded');
                loadingDiv.style.display = 'none';
                
                // Enhance the loaded materials for better realism
                obj.traverse(function (child) {
                  if (child.isMesh) {
                    // Keep the texture but enhance the material properties
                    if (child.material.map) {
                      // Has texture - enhance it
                      child.material.shininess = 15;
                      child.material.transparent = true;
                      child.material.opacity = 0.98;
                      child.castShadow = true;
                      child.receiveShadow = true;
                      console.log('ğŸ“¸ Applied face texture');
                    } else {
                      // Fallback material
                      child.material = new THREE.MeshPhongMaterial({ 
                        color: 0xffdbac,
                        shininess: 15,
                        side: THREE.DoubleSide
                      });
                    }
                  }
                });
                
                // Position and scale the model
                obj.position.set(0, -0.2, 0);
                obj.scale.set(3, 3, 3);
                
                // Store reference
                window.faceModel = obj;
                scene.add(obj);
                
                console.log('ğŸ­ Realistic textured face added to scene');
              },
              function (progress) {
                const percent = progress.total > 0 ? (progress.loaded / progress.total * 100) : 0;
                console.log('Loading model:', percent.toFixed(1) + '%');
                loadingDiv.innerHTML = `Loading realistic face... ${percent.toFixed(0)}%`;
              },
              function (error) {
                console.warn('âš ï¸ Could not load materials, trying without texture...');
                loadFallbackModel();
              }
            );
          },
          function (progress) {
            console.log('Loading materials:', (progress.loaded / progress.total * 100) + '%');
          },
          function (error) {
            console.warn('âš ï¸ Materials not found, loading basic model...');
            loadFallbackModel();
          }
        );
      }
      
      // Fallback if materials/texture fail to load
      function loadFallbackModel() {
        const loader = new OBJLoader();
        loader.load('face.obj', 
          function (obj) {
            console.log('âœ… Basic face model loaded');
            loadingDiv.style.display = 'none';
            
            obj.traverse(function (child) {
              if (child.isMesh) {
                child.material = new THREE.MeshPhongMaterial({ 
                  color: 0xffdbac,
                  shininess: 15,
                  side: THREE.DoubleSide
                });
              }
            });
            
            obj.position.set(0, -0.2, 0);
            obj.scale.set(3, 3, 3);
            window.faceModel = obj;
            scene.add(obj);
            console.log('ğŸ­ Basic face model added');
          },
          undefined,
          function (error) {
            console.error('âŒ Error loading face model:', error);
            loadingDiv.innerHTML = 'Error loading 3D face. Check console.';
            loadingDiv.style.color = '#ff6b6b';
          }
        );
      }
      
      // Start loading the model
      loadTexturedModel();

      // Camera position
      camera.position.set(0, 0, 3);

      // Handle window resize
      window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Enhanced 3D Viewing Modes
      function setupWebXR() {
        // Check for VR support
        if ('xr' in navigator) {
          navigator.xr.isSessionSupported('immersive-vr').then((supported) => {
            if (supported) {
              vrButton.disabled = false;
              vrButton.onclick = () => {
                const sessionInit = { requiredFeatures: ['local-floor'] };
                navigator.xr.requestSession('immersive-vr', sessionInit).then(onSessionStarted);
              };
            }
          });
          
          // Check for AR support  
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            if (supported) {
              arButton.disabled = false;
              arButton.onclick = () => {
                const sessionInit = { 
                  requiredFeatures: ['local-floor'],
                  optionalFeatures: ['dom-overlay'],
                  domOverlay: { root: document.body }
                };
                navigator.xr.requestSession('immersive-ar', sessionInit).then(onSessionStarted);
              };
            }
          });
        }
        
        // Enhanced fallback experiences
        setTimeout(() => {
          if (vrButton.disabled) {
            vrButton.textContent = 'Stereo 3D Mode ğŸ‘€';
            vrButton.onclick = enableStereoMode;
            vrButton.disabled = false;
          }
          if (arButton.disabled) {
            arButton.textContent = 'Cinema Mode ğŸ¬';
            arButton.onclick = enableCinemaMode;
            arButton.disabled = false;
          }
        }, 1000);
      }
      
      // Alternative immersive modes for non-AR/VR devices
      function enableStereoMode() {
        // Create side-by-side stereo view for 3D glasses or cross-eye viewing
        renderer.setSize(window.innerWidth, window.innerHeight);
        
        // Split screen for stereo 3D
        const eyeSeparation = 0.064; // Average human eye separation
        camera.position.set(-eyeSeparation/2, 0, 3);
        
        console.log('ğŸ‘€ Stereo 3D Mode: Cross your eyes or use 3D glasses!');
        document.getElementById('info').innerHTML = '<strong>ï¿½ STEREO 3D MODE</strong><br>Cross your eyes to see in 3D!';
      }
      
      function enableCinemaMode() {
        // Dramatic lighting and camera movement
        scene.fog = new THREE.Fog(0x000000, 1, 10);
        renderer.setClearColor(0x000000);
        
        // Add dramatic lighting
        const spotLight = new THREE.SpotLight(0xffffff, 2);
        spotLight.position.set(2, 2, 2);
        spotLight.angle = Math.PI / 6;
        spotLight.penumbra = 0.3;
        scene.add(spotLight);
        
        // Auto-rotate the face
        if (window.faceModel) {
          const rotateSpeed = 0.01;
          const cinematicRotate = () => {
            window.faceModel.rotation.y += rotateSpeed;
            requestAnimationFrame(cinematicRotate);
          };
          cinematicRotate();
        }
        
        console.log('ğŸ¬ Cinema Mode: Dramatic presentation activated!');
        document.getElementById('info').innerHTML = '<strong>ğŸ¬ CINEMA MODE</strong><br>Dramatic 3D presentation';
      }
      
      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);
        renderer.xr.setSession(session);
        
        // Adjust face model for VR/AR viewing
        if (window.faceModel) {
          if (session.mode === 'immersive-ar') {
            // In AR, make it smaller and positioned in front of user
            window.faceModel.scale.set(0.3, 0.3, 0.3);
            window.faceModel.position.set(0, 0, -0.5);
          } else {
            // In VR, make it life-size
            window.faceModel.scale.set(1, 1, 1);
            window.faceModel.position.set(0, 0, -1);
          }
        }
      }
      
      function onSessionEnded() {
        // Reset model size when exiting VR/AR
        if (window.faceModel) {
          window.faceModel.scale.set(3, 3, 3);
          window.faceModel.position.set(0, -0.2, 0);
        }
      }
      
      // Enhanced viewing mode buttons
      fullscreenBtn.onclick = () => {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen();
          fullscreenBtn.textContent = 'Exit Fullscreen ğŸ“º';
        } else {
          document.exitFullscreen();
          fullscreenBtn.textContent = 'Fullscreen ğŸ“º';
        }
      };
      
      lifeSizeBtn.onclick = () => {
        if (window.faceModel) {
          // Set to approximately life-size (assuming 20cm face height)
          window.faceModel.scale.set(1, 1, 1);
          camera.position.set(0, 0, 0.5); // Close viewing distance
          controls.target.set(0, 0, 0);
          controls.update();
          console.log('ğŸ‘¤ Life-size mode activated');
        }
      };
      
      closeUpBtn.onclick = () => {
        if (window.faceModel) {
          // Zoom in for detail viewing
          camera.position.set(0, 0, 0.3);
          window.faceModel.scale.set(1.5, 1.5, 1.5);
          controls.target.set(0, 0, 0);
          controls.update();
          console.log('ğŸ” Close-up mode activated');
        }
      };
      
      mirrorBtn.onclick = () => {
        if (window.faceModel) {
          // Mirror view - like looking in a mirror
          window.faceModel.scale.set(-2, 2, 2); // Flip X for mirror effect
          camera.position.set(0, 0, 1);
          controls.target.set(0, 0, 0);
          controls.update();
          console.log('ğŸª Mirror mode: See yourself as others see you!');
        }
      };

      // Animation loop (works for both normal and XR modes)
      function animate() {
        renderer.setAnimationLoop(render);
      }
      
      function render() {
        controls.update();
        renderer.render(scene, camera);
      }
      
      animate();
      console.log('ğŸš€ 3D viewer with VR/AR support initialized');
    </script>
  </body>
</html>
